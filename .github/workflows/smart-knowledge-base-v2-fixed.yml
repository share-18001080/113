name: AI Knowledge Base (Fixed v3)

on:
  workflow_run:
    workflows: ["*"]
    types: [completed]

permissions:
  actions: read
  contents: write

jobs:
  ai-analyze-error:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Táº£i log workflow bá»‹ lá»—i
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID=${{ github.event.workflow_run.id }}
          
          curl -L \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/runs/${RUN_ID}/logs \
            -o current-log.zip
          
          unzip -q current-log.zip -d current-log/
          find current-log/ -name "*.txt" -exec cat {} \; > full-log.txt
          
          # Láº¥y 3000 dÃ²ng cuá»‘i (Ä‘á»§ cho phÃ¢n tÃ­ch)
          tail -n 3000 full-log.txt > log-for-ai.txt

      - name: Test Gemini API Key
        id: test_api
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "âŒ ERROR: GEMINI_API_KEY chÆ°a Ä‘Æ°á»£c set!"
            echo "api_key_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          TEST_RESPONSE=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"contents":[{"parts":[{"text":"Hello"}]}]}')
          
          if echo "$TEST_RESPONSE" | grep -q '"error"'; then
            echo "âŒ API Key khÃ´ng há»£p lá»‡"
            echo "$TEST_RESPONSE"
            echo "api_key_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… API Key há»£p lá»‡"
          echo "api_key_valid=true" >> $GITHUB_OUTPUT

      - name: Chuáº©n bá»‹ prompt vÃ  gá»i Gemini API
        id: ai_analysis
        if: steps.test_api.outputs.api_key_valid == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # Láº¥y log (giá»›i háº¡n 15KB Ä‘á»ƒ cháº¯c cháº¯n)
          LOG_TEXT=$(head -c 15000 log-for-ai.txt | tr -d '\000-\037' | sed 's/"/\\"/g')
          
          # Táº¡o prompt (escape Ä‘Ãºng)
          PROMPT="Báº¡n lÃ  chuyÃªn gia phÃ¢n tÃ­ch lá»—i FFmpeg Android build.

          WORKFLOW: ${{ github.event.workflow_run.name }}
          RUN: #${{ github.event.workflow_run.run_number }}

          PhÃ¢n tÃ­ch log lá»—i sau vÃ  tráº£ vá» ÄÃšNG JSON format (khÃ´ng thÃªm markdown):

          {
            \"error_id\": \"ERROR-XXX\",
            \"error_name\": \"MÃ´ táº£ ngáº¯n gá»n\",
            \"root_cause\": \"NguyÃªn nhÃ¢n gá»‘c\",
            \"affected_library\": \"libass\",
            \"error_type\": \"DEPENDENCY\",
            \"symptoms\": [\"lá»—i 1\", \"lá»—i 2\"],
            \"fix_suggestion\": \"CÃ¡ch fix\",
            \"confidence\": 90
          }

          LOG:
          $LOG_TEXT"
          
          # Escape prompt cho JSON
          ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs .)
          
          echo "ðŸ“¤ Gá»­i request tá»›i Gemini..."
          
          # Gá»i API vá»›i JSON Ä‘Ãºng format
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"contents\": [{
                \"parts\": [{
                  \"text\": $ESCAPED_PROMPT
                }]
              }],
              \"generationConfig\": {
                \"temperature\": 0.1,
                \"maxOutputTokens\": 1024,
                \"responseMimeType\": \"application/json\"
              }
            }")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1 | cut -d: -f2)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ API error:"
            echo "$RESPONSE_BODY" | jq . || echo "$RESPONSE_BODY"
            
            # Fallback: grep lá»—i chÃ­nh
            FIRST_ERROR=$(grep -m 1 "error:" log-for-ai.txt | head -c 200 || echo "Unknown build error")
            
            cat > ai-analysis.json << 'EOFJSON'
          {
            "error_id": "ERROR-999",
            "error_name": "API call failed - Fallback analysis",
            "root_cause": "Gemini API khÃ´ng kháº£ dá»¥ng hoáº·c request lá»—i",
            "affected_library": "unknown",
            "error_type": "UNKNOWN",
            "symptoms": ["API HTTP error"],
            "fix_suggestion": "Cáº§n phÃ¢n tÃ­ch log thá»§ cÃ´ng",
            "confidence": 20
          }
          EOFJSON
          else
            echo "âœ… API success"
            
            # Parse response
            AI_TEXT=$(echo "$RESPONSE_BODY" | jq -r '.candidates[0].content.parts[0].text' 2>/dev/null || echo "")
            
            if [ -z "$AI_TEXT" ] || [ "$AI_TEXT" = "null" ]; then
              echo "âŒ Empty response from Gemini"
              
              FIRST_ERROR=$(grep -m 1 "error:" log-for-ai.txt | head -c 200 || echo "Parse failed")
              
              cat > ai-analysis.json << 'EOFJSON'
          {
            "error_id": "ERROR-998",
            "error_name": "Empty AI response",
            "root_cause": "Gemini tráº£ vá» response rá»—ng",
            "affected_library": "unknown",
            "error_type": "UNKNOWN",
            "symptoms": ["Empty response"],
            "fix_suggestion": "Retry hoáº·c phÃ¢n tÃ­ch thá»§ cÃ´ng",
            "confidence": 15
          }
          EOFJSON
            else
              echo "âœ… Nháº­n Ä‘Æ°á»£c AI analysis:"
              echo "$AI_TEXT"
              
              # LÆ°u JSON (Gemini Ä‘Ã£ tráº£ vá» JSON thuáº§n)
              echo "$AI_TEXT" > ai-analysis.json
              
              # Validate
              if ! jq empty ai-analysis.json 2>/dev/null; then
                echo "âš ï¸ JSON khÃ´ng há»£p lá»‡, táº¡o fallback"
                
                cat > ai-analysis.json << 'EOFJSON'
          {
            "error_id": "ERROR-997",
            "error_name": "Invalid JSON from AI",
            "root_cause": "AI response khÃ´ng parse Ä‘Æ°á»£c",
            "affected_library": "unknown",
            "error_type": "UNKNOWN",
            "symptoms": ["Invalid JSON"],
            "fix_suggestion": "Cáº§n review AI prompt",
            "confidence": 10
          }
          EOFJSON
              fi
            fi
          fi
          
          cat ai-analysis.json
          
          # Extract vá»›i default values
          echo "error_id=$(jq -r '.error_id // "ERROR-000"' ai-analysis.json)" >> $GITHUB_OUTPUT
          echo "error_name=$(jq -r '.error_name // "Unknown"' ai-analysis.json)" >> $GITHUB_OUTPUT
          echo "affected_lib=$(jq -r '.affected_library // "unknown"' ai-analysis.json)" >> $GITHUB_OUTPUT

      - name: Khá»Ÿi táº¡o Knowledge Base
        run: |
          if [ ! -f .github/ERROR_KNOWLEDGE_BASE.md ]; then
            cat > .github/ERROR_KNOWLEDGE_BASE.md << 'EOFKB'
          # ðŸ“š FFmpeg Android ARM32 - Error Knowledge Base

          > **Cáº­p nháº­t:** Tá»± Ä‘á»™ng bá»Ÿi AI (Gemini 2.0 Flash)  
          > **Tá»•ng sá»‘ lá»—i:** 0

          ---

          ## ðŸ“‹ Quick Reference

          | ID | TÃªn lá»—i | ThÆ° viá»‡n | Workflow | NgÃ y |
          |----|---------|----------|----------|------|

          ---

          ## ðŸ”´ Chi tiáº¿t lá»—i

          EOFKB
            
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .github/ERROR_KNOWLEDGE_BASE.md
            git commit -m "docs: Khá»Ÿi táº¡o KB"
          fi

      - name: ThÃªm entry vÃ o Knowledge Base
        env:
          ERROR_ID: ${{ steps.ai_analysis.outputs.error_id }}
          ERROR_NAME: ${{ steps.ai_analysis.outputs.error_name }}
          AFFECTED_LIB: ${{ steps.ai_analysis.outputs.affected_lib }}
        run: |
          AI_JSON=$(cat ai-analysis.json)
          
          ROOT_CAUSE=$(echo "$AI_JSON" | jq -r '.root_cause // "N/A"')
          ERROR_TYPE=$(echo "$AI_JSON" | jq -r '.error_type // "UNKNOWN"')
          FIX_SUGGESTION=$(echo "$AI_JSON" | jq -r '.fix_suggestion // "N/A"')
          SYMPTOMS=$(echo "$AI_JSON" | jq -r '.symptoms // ["N/A"] | join(", ")')
          CONFIDENCE=$(echo "$AI_JSON" | jq -r '.confidence // 0')
          
          # Cáº­p nháº­t Quick Reference
          sed -i "/^| ID | TÃªn lá»—i/a | $ERROR_ID | $ERROR_NAME | $AFFECTED_LIB | ${{ github.event.workflow_run.name }} | $(date +%Y-%m-%d) |" .github/ERROR_KNOWLEDGE_BASE.md
          
          # Cáº­p nháº­t tá»•ng (fix arithmetic error)
          TOTAL_ERRORS=$(grep -c "^### ðŸ”´ ERROR-" .github/ERROR_KNOWLEDGE_BASE.md 2>/dev/null || echo "0")
          TOTAL_ERRORS=$(echo "$TOTAL_ERRORS" | tr -d '\n\r ')
          NEW_TOTAL=$((TOTAL_ERRORS + 1))
          sed -i "s/Tá»•ng sá»‘ lá»—i:\*\* [0-9]*/Tá»•ng sá»‘ lá»—i:** $NEW_TOTAL/" .github/ERROR_KNOWLEDGE_BASE.md
          
          # ThÃªm chi tiáº¿t
          cat >> .github/ERROR_KNOWLEDGE_BASE.md << EOFENTRY

          ### ðŸ”´ $ERROR_ID: $ERROR_NAME

          **ðŸ“… NgÃ y:** $(date +%Y-%m-%d)

          **ðŸ“¦ Workflow:** ${{ github.event.workflow_run.name }} [#${{ github.event.workflow_run.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})

          **ðŸŽ¯ ThÆ° viá»‡n:** \`$AFFECTED_LIB\`

          **ðŸ¤– Äá»™ tin cáº­y:** ${CONFIDENCE}%

          **âš ï¸ Triá»‡u chá»©ng:** $SYMPTOMS

          **ðŸ” NguyÃªn nhÃ¢n:** $ROOT_CAUSE

          **ðŸ› ï¸ Fix:** $FIX_SUGGESTION

          **ðŸ“ Loáº¡i:** \`$ERROR_TYPE\`

          ---

          EOFENTRY

      - name: Commit vÃ  push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .github/ERROR_KNOWLEDGE_BASE.md
          
          if git diff --staged --quiet; then
            echo "KhÃ´ng cÃ³ thay Ä‘á»•i"
          else
            git commit -m "ðŸ¤– ${{ steps.ai_analysis.outputs.error_id }}"
            git push
          fi

      - name: Debug Summary
        if: always()
        run: |
          echo "## ðŸ” Debug Info" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API Key:** ${{ steps.test_api.outputs.api_key_valid }}" >> $GITHUB_STEP_SUMMARY
          echo "**Error ID:** ${{ steps.ai_analysis.outputs.error_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### AI Analysis:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          cat ai-analysis.json >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: rm -rf current-log/ current-log.zip full-log.txt log-for-ai.txt ai-analysis.json
