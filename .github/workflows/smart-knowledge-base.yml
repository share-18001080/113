name: Smart Knowledge Base (Gemini AI)

on:
  workflow_run:
    workflows: ["*"]
    types: [completed]

permissions:
  actions: read
  contents: write

jobs:
  ai-analyze-error:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: T·∫£i log workflow b·ªã l·ªói
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID=${{ github.event.workflow_run.id }}
          
          curl -L \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/runs/${RUN_ID}/logs \
            -o current-log.zip
          
          unzip -q current-log.zip -d current-log/
          
          # G·ªôp t·∫•t c·∫£ log th√†nh 1 file
          find current-log/ -name "*.txt" -exec cat {} \; > full-log.txt
          
          # L·∫•y 10000 d√≤ng cu·ªëi (quan tr·ªçng nh·∫•t)
          tail -n 10000 full-log.txt > log-for-ai.txt

      - name: Chu·∫©n b·ªã context cho AI
        run: |
          # T·∫°o file ch·ª©a workflow name v√† info
          cat > context.txt << 'EOFCONTEXT'
          WORKFLOW: ${{ github.event.workflow_run.name }}
          RUN: #${{ github.event.workflow_run.run_number }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
          
          NHI·ªÜM V·ª§ C·ª¶A B·∫†N:
          B·∫°n l√† chuy√™n gia ph√¢n t√≠ch l·ªói build FFmpeg Android ARM32.
          
          Workflow n√†y ƒëang c·ªë g·∫Øng th√™m th∆∞ vi·ªán LibASS v√†o FFmpeg.
          C√°c th∆∞ vi·ªán ƒë√£ build th√†nh c√¥ng ·ªü version tr∆∞·ªõc: x264, x265, vpx, opus, lame, twolame, ogg, vorbis, theora, speex, gsm, fribidi, fdk-aac, aom, soxr, webp, freetype, openjpeg.
          
          QUAN TR·ªåNG:
          - Ph√¢n bi·ªát l·ªói M·ªöI (li√™n quan LibASS) vs l·ªói CASCADE (do thi·∫øu LibASS)
          - Kh√¥ng b√°o l·ªói c√°c th∆∞ vi·ªán ƒë√£ build th√†nh c√¥ng
          - Ch·ªâ t·∫≠p trung v√†o ROOT CAUSE (nguy√™n nh√¢n g·ªëc)
          
          Y√äU C·∫¶U PH√ÇN T√çCH:
          1. ERROR_ID: T·∫°o ID theo format ERROR-XXX (Dependencies=0XX, Linker=1XX, Configure=2XX, Syntax=3XX)
          2. ERROR_NAME: T√™n l·ªói ng·∫Øn g·ªçn, ch√≠nh x√°c (v√≠ d·ª•: "LibASS missing fontconfig.pc")
          3. ROOT_CAUSE: Nguy√™n nh√¢n g·ªëc r·ªÖ (kh√¥ng ph·∫£i tri·ªáu ch·ª©ng)
          4. AFFECTED_LIBRARY: Th∆∞ vi·ªán B·ªä ·∫¢NH H∆Ø·ªûNG (ch·ªâ ghi 1 th∆∞ vi·ªán ch√≠nh)
          5. ERROR_TYPE: [DEPENDENCY|LINKER|CONFIGURE|SYNTAX|UNKNOWN]
          6. FIX_SUGGESTION: G·ª£i √Ω fix c·ª• th·ªÉ (code YAML n·∫øu c√≥ th·ªÉ)
          7. SIMILAR_ERRORS: C√≥ l·ªói t∆∞∆°ng t·ª± trong Knowledge Base kh√¥ng? (ƒë·ªçc file .github/ERROR_KNOWLEDGE_BASE.md n·∫øu c√≥)
          
          Output format (JSON):
          {
            "error_id": "ERROR-XXX",
            "error_name": "...",
            "root_cause": "...",
            "affected_library": "libass",
            "error_type": "DEPENDENCY",
            "symptoms": ["d√≤ng l·ªói 1", "d√≤ng l·ªói 2"],
            "fix_suggestion": "...",
            "similar_errors": ["ERROR-001", "ERROR-002"],
            "confidence": 95
          }
          EOFCONTEXT

      - name: G·ªçi Gemini API ƒë·ªÉ ph√¢n t√≠ch
        id: ai_analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # ƒê·ªçc log (gi·ªõi h·∫°n 50KB ƒë·ªÉ kh√¥ng v∆∞·ª£t token limit)
          LOG_CONTENT=$(head -c 50000 log-for-ai.txt | base64 -w 0)
          CONTEXT=$(cat context.txt)
          
          # ƒê·ªçc Knowledge Base hi·ªán t·∫°i (n·∫øu c√≥)
          if [ -f .github/ERROR_KNOWLEDGE_BASE.md ]; then
            KB_CONTENT=$(head -c 20000 .github/ERROR_KNOWLEDGE_BASE.md | base64 -w 0)
            KB_PROMPT=", v√† ƒë√¢y l√† Knowledge Base hi·ªán t·∫°i (base64): $KB_CONTENT"
          else
            KB_PROMPT=""
          fi
          
          # G·ªçi Gemini API
          RESPONSE=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"contents\": [{
                \"parts\": [{
                  \"text\": \"$CONTEXT\n\nƒê√¢y l√† log l·ªói (base64): $LOG_CONTENT$KB_PROMPT\n\nH√£y ph√¢n t√≠ch v√† tr·∫£ v·ªÅ JSON nh∆∞ y√™u c·∫ßu.\"
                }]
              }],
              \"generationConfig\": {
                \"temperature\": 0.2,
                \"topK\": 40,
                \"topP\": 0.95,
                \"maxOutputTokens\": 2048
              }
            }")
          
          # Parse JSON response
          AI_RESULT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text')
          
          # Extract JSON t·ª´ markdown code block n·∫øu c√≥
          if echo "$AI_RESULT" | grep -q '```
            AI_JSON=$(echo "$AI_RESULT" | sed -n '/```json/,/```
          else
            AI_JSON="$AI_RESULT"
          fi
          
          echo "AI Analysis Result:"
          echo "$AI_JSON"
          
          # Save to file
          echo "$AI_JSON" > ai-analysis.json
          
          # Extract fields ƒë·ªÉ d√πng trong c√°c b∆∞·ªõc sau
          echo "error_id=$(echo "$AI_JSON" | jq -r '.error_id')" >> $GITHUB_OUTPUT
          echo "error_name=$(echo "$AI_JSON" | jq -r '.error_name')" >> $GITHUB_OUTPUT
          echo "affected_lib=$(echo "$AI_JSON" | jq -r '.affected_library')" >> $GITHUB_OUTPUT

      - name: Kh·ªüi t·∫°o Knowledge Base n·∫øu ch∆∞a c√≥
        run: |
          if [ ! -f .github/ERROR_KNOWLEDGE_BASE.md ]; then
            cat > .github/ERROR_KNOWLEDGE_BASE.md << 'EOFKB'
          # üìö FFmpeg Android ARM32 - Error Knowledge Base
          
          > **C·∫≠p nh·∫≠t:** T·ª± ƒë·ªông b·ªüi AI (Gemini 2.0 Flash)
          > 
          > **T·ªïng s·ªë l·ªói:** 0
          
          ---
          
          ## üìã Quick Reference
          
          | ID | T√™n l·ªói | Th∆∞ vi·ªán | Workflow | Ng√†y |
          |----|---------|----------|----------|------|
          
          ---
          
          ## üî¥ Chi ti·∫øt l·ªói
          
          EOFKB
          
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .github/ERROR_KNOWLEDGE_BASE.md
            git commit -m "docs: Kh·ªüi t·∫°o Error Knowledge Base"
          fi

      - name: Th√™m entry AI-analyzed v√†o Knowledge Base
        env:
          ERROR_ID: ${{ steps.ai_analysis.outputs.error_id }}
          ERROR_NAME: ${{ steps.ai_analysis.outputs.error_name }}
          AFFECTED_LIB: ${{ steps.ai_analysis.outputs.affected_lib }}
        run: |
          AI_JSON=$(cat ai-analysis.json)
          
          # Parse c√°c field t·ª´ JSON
          ROOT_CAUSE=$(echo "$AI_JSON" | jq -r '.root_cause')
          ERROR_TYPE=$(echo "$AI_JSON" | jq -r '.error_type')
          FIX_SUGGESTION=$(echo "$AI_JSON" | jq -r '.fix_suggestion')
          SYMPTOMS=$(echo "$AI_JSON" | jq -r '.symptoms | join("\n")')
          CONFIDENCE=$(echo "$AI_JSON" | jq -r '.confidence')
          
          # C·∫≠p nh·∫≠t Quick Reference
          sed -i "/^| ID | T√™n l·ªói/a | $ERROR_ID | $ERROR_NAME | $AFFECTED_LIB | ${{ github.event.workflow_run.name }} | $(date +%Y-%m-%d) |" .github/ERROR_KNOWLEDGE_BASE.md
          
          # C·∫≠p nh·∫≠t t·ªïng s·ªë l·ªói
          TOTAL_ERRORS=$(grep -c "^### üî¥ ERROR-" .github/ERROR_KNOWLEDGE_BASE.md || echo "0")
          NEW_TOTAL=$((TOTAL_ERRORS + 1))
          sed -i "s/\*\*T·ªïng s·ªë l·ªói:\*\* [0-9]*/\*\*T·ªïng s·ªë l·ªói:\*\* $NEW_TOTAL/" .github/ERROR_KNOWLEDGE_BASE.md
          
          # Th√™m chi ti·∫øt l·ªói
          cat >> .github/ERROR_KNOWLEDGE_BASE.md << EOFENTRY
          
          ### üî¥ $ERROR_ID: $ERROR_NAME
          
          **üìÖ Ng√†y:** $(date +%Y-%m-%d)
          
          **üì¶ Workflow:** ${{ github.event.workflow_run.name }} [Run #${{ github.event.workflow_run.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})
          
          **üéØ Th∆∞ vi·ªán b·ªã ·∫£nh h∆∞·ªüng:** \`$AFFECTED_LIB\`
          
          **ü§ñ ƒê·ªô tin c·∫≠y AI:** ${CONFIDENCE}%
          
          **‚ö†Ô∏è Tri·ªáu ch·ª©ng:**
          \`\`\`bash
          $SYMPTOMS
          \`\`\`
          
          **üîç Nguy√™n nh√¢n g·ªëc r·ªÖ (ph√¢n t√≠ch b·ªüi AI):**
          $ROOT_CAUSE
          
          **üõ†Ô∏è G·ª£i √Ω fix:**
          $FIX_SUGGESTION
          
          **üìù Lo·∫°i l·ªói:** \`$ERROR_TYPE\`
          
          **üè∑Ô∏è Tags:** \`ai-analyzed\` \`$AFFECTED_LIB\` \`$ERROR_TYPE\`
          
          ---
          
          EOFENTRY

      - name: Commit v√† push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .github/ERROR_KNOWLEDGE_BASE.md
          
          if git diff --staged --quiet; then
            echo "Kh√¥ng c√≥ thay ƒë·ªïi"
          else
            git commit -m "ü§ñ AI: ${{ steps.ai_analysis.outputs.error_id }} - ${{ steps.ai_analysis.outputs.error_name }}

          Ph√¢n t√≠ch b·ªüi: Gemini 2.0 Flash
          Workflow: ${{ github.event.workflow_run.name }}
          Th∆∞ vi·ªán: ${{ steps.ai_analysis.outputs.affected_lib }}"
            
            git push
          fi

      - name: Hi·ªÉn th·ªã k·∫øt qu·∫£
        run: |
          echo "## ü§ñ AI ƒê√£ Ph√¢n T√≠ch L·ªói" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ERROR ID:** ${{ steps.ai_analysis.outputs.error_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**L·ªói:** ${{ steps.ai_analysis.outputs.error_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Th∆∞ vi·ªán:** ${{ steps.ai_analysis.outputs.affected_lib }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìÑ Chi ti·∫øt ph√¢n t√≠ch:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          cat ai-analysis.json >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**File Knowledge Base:** [Xem t·∫°i ƒë√¢y](https://github.com/${{ github.repository }}/blob/main/.github/ERROR_KNOWLEDGE_BASE.md)" >> $GITHUB_STEP_SUMMARY

      - name: D·ªçn d·∫πp
        run: rm -rf current-log/ current-log.zip full-log.txt log-for-ai.txt context.txt ai-analysis.json
