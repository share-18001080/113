name: Auto Knowledge Base Generator

on:
  workflow_run:
    workflows: ["*"]
    types: [completed]

permissions:
  actions: read
  contents: write  # C·∫ßn quy·ªÅn write ƒë·ªÉ commit

jobs:
  update-knowledge-base:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: T·∫£i log workflow b·ªã l·ªói
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID=${{ github.event.workflow_run.id }}
          
          curl -L \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/runs/${RUN_ID}/logs \
            -o current-log.zip
          
          unzip -q current-log.zip -d current-log/

      - name: Ph√¢n t√≠ch l·ªói t·ª± ƒë·ªông
        id: analyze
        run: |
          echo "ƒêang ph√¢n t√≠ch log..."
          
          # Tr√≠ch xu·∫•t c√°c lo·∫°i l·ªói ch√≠nh
          ERROR_TYPES=""
          
          # Ki·ªÉm tra l·ªói dependencies
          if grep -q "not found\|No such file" current-log/; then
            ERROR_TYPES="${ERROR_TYPES}DEPENDENCY "
            echo "error_category=Dependencies" >> $GITHUB_OUTPUT
          fi
          
          # Ki·ªÉm tra l·ªói linker
          if grep -q "undefined reference" current-log/; then
            ERROR_TYPES="${ERROR_TYPES}LINKER "
            echo "error_category=Linker" >> $GITHUB_OUTPUT
          fi
          
          # Ki·ªÉm tra l·ªói configure
          if grep -q "configure: error" current-log/; then
            ERROR_TYPES="${ERROR_TYPES}CONFIGURE "
            echo "error_category=Configure" >> $GITHUB_OUTPUT
          fi
          
          # Ki·ªÉm tra l·ªói workflow syntax
          if grep -q "syntax error\|unexpected EOF" current-log/; then
            ERROR_TYPES="${ERROR_TYPES}SYNTAX "
            echo "error_category=Workflow-Syntax" >> $GITHUB_OUTPUT
          fi
          
          # M·∫∑c ƒë·ªãnh n·∫øu kh√¥ng match
          if [ -z "$ERROR_TYPES" ]; then
            echo "error_category=Unknown" >> $GITHUB_OUTPUT
          fi
          
          # Tr√≠ch xu·∫•t d√≤ng l·ªói ch√≠nh (50 d√≤ng ƒë·∫ßu ti√™n ch·ª©a error)
          grep -rh "error:\|ERROR:\|failed\|undefined reference" current-log/ | head -n 50 > main-errors.txt || echo "No specific errors found" > main-errors.txt
          
          # Tr√≠ch xu·∫•t context (100 d√≤ng cu·ªëi c·ªßa log)
          find current-log/ -name "*.txt" -exec tail -n 100 {} \; | tail -n 100 > error-context.txt || echo "No context" > error-context.txt
          
          # ƒê·∫øm s·ªë l·∫ßn l·ªói n√†y xu·∫•t hi·ªán trong qu√° kh·ª©
          if [ -f .github/ERROR_KNOWLEDGE_BASE.md ]; then
            FIRST_ERROR_LINE=$(head -n 1 main-errors.txt)
            FREQUENCY=$(grep -c "$FIRST_ERROR_LINE" .github/ERROR_KNOWLEDGE_BASE.md || echo "0")
            echo "frequency=$FREQUENCY" >> $GITHUB_OUTPUT
          else
            echo "frequency=0" >> $GITHUB_OUTPUT
          fi

      - name: Kh·ªüi t·∫°o Knowledge Base n·∫øu ch∆∞a c√≥
        run: |
          if [ ! -f .github/ERROR_KNOWLEDGE_BASE.md ]; then
            cat > .github/ERROR_KNOWLEDGE_BASE.md << 'EOFKB'
          # üìö FFmpeg Android ARM32 - Error Knowledge Base
          
          > **M·ª•c ƒë√≠ch:** T·ª± ƒë·ªông ghi l·∫°i to√†n b·ªô l·ªói build ƒë·ªÉ tr√°nh l·∫∑p l·∫°i sai l·∫ßm
          > 
          > **C·∫≠p nh·∫≠t:** T·ª± ƒë·ªông b·ªüi GitHub Actions
          > 
          > **T·ªïng s·ªë l·ªói:** 0
          
          ---
          
          ## üìã Quick Reference
          
          | ID | T√™n l·ªói | T·∫ßn su·∫•t | Workflow | Ng√†y |
          |----|---------|----------|----------|------|
          
          ---
          
          ## üî¥ Chi ti·∫øt l·ªói
          
          EOFKB
          
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .github/ERROR_KNOWLEDGE_BASE.md
            git commit -m "docs: Kh·ªüi t·∫°o Error Knowledge Base"
          fi

      - name: T·∫°o ERROR ID m·ªõi
        id: error_id
        run: |
          # ƒê·∫øm s·ªë l·ªói hi·ªán c√≥
          if [ -f .github/ERROR_KNOWLEDGE_BASE.md ]; then
            ERROR_COUNT=$(grep -c "^### üî¥ ERROR-" .github/ERROR_KNOWLEDGE_BASE.md || echo "0")
          else
            ERROR_COUNT=0
          fi
          
          NEXT_NUM=$((ERROR_COUNT + 1))
          
          # Ph√¢n lo·∫°i theo category
          CATEGORY="${{ steps.analyze.outputs.error_category }}"
          
          case $CATEGORY in
            Dependencies)
              ERROR_ID=$(printf "ERROR-0%02d" $NEXT_NUM)
              ;;
            Linker)
              ERROR_ID=$(printf "ERROR-1%02d" $NEXT_NUM)
              ;;
            Configure)
              ERROR_ID=$(printf "ERROR-2%02d" $NEXT_NUM)
              ;;
            Workflow-Syntax)
              ERROR_ID=$(printf "ERROR-3%02d" $NEXT_NUM)
              ;;
            *)
              ERROR_ID=$(printf "ERROR-9%02d" $NEXT_NUM)
              ;;
          esac
          
          echo "error_id=$ERROR_ID" >> $GITHUB_OUTPUT
          echo "Generated ERROR ID: $ERROR_ID"

      - name: T·∫°o t√™n l·ªói t·ª± ƒë·ªông
        id: error_name
        run: |
          # L·∫•y t·ª´ kh√≥a ch√≠nh t·ª´ l·ªói
          FIRST_ERROR=$(head -n 1 main-errors.txt)
          
          # Extract t√™n l·ªói th√¥ng minh
          if echo "$FIRST_ERROR" | grep -q "undefined reference to"; then
            SYMBOL=$(echo "$FIRST_ERROR" | grep -oP "undefined reference to '\K[^']+")
            ERROR_NAME="Undefined reference to ${SYMBOL}"
          elif echo "$FIRST_ERROR" | grep -q "not found"; then
            PACKAGE=$(echo "$FIRST_ERROR" | grep -oP "Package '\K[^']+")
            if [ -n "$PACKAGE" ]; then
              ERROR_NAME="Package $PACKAGE not found"
            else
              ERROR_NAME="File or package not found"
            fi
          elif echo "$FIRST_ERROR" | grep -q "configure: error"; then
            ERROR_NAME="Configure failed"
          elif echo "$FIRST_ERROR" | grep -q "syntax error"; then
            ERROR_NAME="Workflow syntax error"
          else
            ERROR_NAME="Build failed - See details"
          fi
          
          echo "error_name=$ERROR_NAME" >> $GITHUB_OUTPUT
          echo "Error name: $ERROR_NAME"

      - name: Th√™m entry v√†o Knowledge Base
        env:
          ERROR_ID: ${{ steps.error_id.outputs.error_id }}
          ERROR_NAME: ${{ steps.error_name.outputs.error_name }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          RUN_NUMBER: ${{ github.event.workflow_run.run_number }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          FREQUENCY: ${{ steps.analyze.outputs.frequency }}
        run: |
          # C·∫≠p nh·∫≠t Quick Reference table
          FREQ_DISPLAY="$((FREQUENCY + 1))"
          sed -i "/^| ID | T√™n l·ªói/a | $ERROR_ID | $ERROR_NAME | ${FREQ_DISPLAY}x | $WORKFLOW_NAME | $(date +%Y-%m-%d) |" .github/ERROR_KNOWLEDGE_BASE.md
          
          # C·∫≠p nh·∫≠t t·ªïng s·ªë l·ªói
          TOTAL_ERRORS=$(grep -c "^### üî¥ ERROR-" .github/ERROR_KNOWLEDGE_BASE.md || echo "0")
          NEW_TOTAL=$((TOTAL_ERRORS + 1))
          sed -i "s/\*\*T·ªïng s·ªë l·ªói:\*\* [0-9]*/\*\*T·ªïng s·ªë l·ªói:\*\* $NEW_TOTAL/" .github/ERROR_KNOWLEDGE_BASE.md
          
          # Th√™m chi ti·∫øt l·ªói
          cat >> .github/ERROR_KNOWLEDGE_BASE.md << EOFENTRY
          
          ### üî¥ $ERROR_ID: $ERROR_NAME
          
          **üìÖ Ng√†y ph√°t hi·ªán:** $(date +%Y-%m-%d)
          
          **üì¶ Workflow:** $WORKFLOW_NAME
          
          **üî¢ Run:** [#$RUN_NUMBER](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)
          
          **üéØ T·∫ßn su·∫•t:** L·∫ßn th·ª© $FREQ_DISPLAY g·∫∑p l·ªói n√†y
          
          **‚ö†Ô∏è Tri·ªáu ch·ª©ng:**
          \`\`\`bash
          $(head -n 20 main-errors.txt)
          \`\`\`
          
          **üìã Context (100 d√≤ng cu·ªëi log):**
          \`\`\`
          $(head -n 50 error-context.txt)
          \`\`\`
          
          **üîç Nguy√™n nh√¢n g·ªëc r·ªÖ:**
          - [ ] TODO: C·∫ßn ph√¢n t√≠ch th·ªß c√¥ng
          - Lo·∫°i l·ªói: ${{ steps.analyze.outputs.error_category }}
          
          **üõ†Ô∏è Fix ƒë√£ th·ª≠:**
          - [ ] TODO: C·∫≠p nh·∫≠t sau khi th·ª≠ fix
          
          **üìù Status:** üî¥ Ch∆∞a fix
          
          **üè∑Ô∏è Tags:** \`${{ steps.analyze.outputs.error_category }}\` \`auto-generated\` \`run-$RUN_NUMBER\`
          
          ---
          
          EOFENTRY

      - name: T·∫°o GitHub Issue t·ª± ƒë·ªông (Optional)
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ERROR_ID: ${{ steps.error_id.outputs.error_id }}
          ERROR_NAME: ${{ steps.error_name.outputs.error_name }}
        run: |
          gh issue create \
            --title "[$ERROR_ID] $ERROR_NAME" \
            --body "L·ªói ƒë∆∞·ª£c ph√°t hi·ªán t·ª± ƒë·ªông t·ª´ workflow **${{ github.event.workflow_run.name }}** run #${{ github.event.workflow_run.run_number }}.

          **Chi ti·∫øt:** Xem file \`.github/ERROR_KNOWLEDGE_BASE.md\` section \`$ERROR_ID\`
          
          **Log ƒë·∫ßy ƒë·ªß:** https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}
          
          **Action items:**
          - [ ] Ph√¢n t√≠ch nguy√™n nh√¢n g·ªëc r·ªÖ
          - [ ] Th·ª≠ fix v√† c·∫≠p nh·∫≠t Knowledge Base
          - [ ] Verify fix kh√¥ng g√¢y l·ªói kh√°c
          
          **Auto-generated by:** \`auto-knowledge-base.yml\`" \
            --label "bug,auto-generated,needs-analysis" \
            --assignee "${{ github.repository_owner }}"

      - name: Commit v√† push Knowledge Base
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .github/ERROR_KNOWLEDGE_BASE.md
          
          if git diff --staged --quiet; then
            echo "Kh√¥ng c√≥ thay ƒë·ªïi, skip commit"
          else
            git commit -m "docs: Th√™m ${{ steps.error_id.outputs.error_id }} - ${{ steps.error_name.outputs.error_name }}

          Workflow: ${{ github.event.workflow_run.name }}
          Run: #${{ github.event.workflow_run.run_number }}
          
          Auto-generated by GitHub Actions"
            
            git push
          fi

      - name: Hi·ªÉn th·ªã t√≥m t·∫Øt
        run: |
          echo "## ‚úÖ Knowledge Base ƒê√£ C·∫≠p Nh·∫≠t" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ERROR ID:** ${{ steps.error_id.outputs.error_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**T√™n l·ªói:** ${{ steps.error_name.outputs.error_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** #${{ github.event.workflow_run.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìÑ File ƒë√£ c·∫≠p nh·∫≠t:" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/ERROR_KNOWLEDGE_BASE.md\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Li√™n k·∫øt:" >> $GITHUB_STEP_SUMMARY
          echo "- [Xem Knowledge Base](https://github.com/${{ github.repository }}/blob/main/.github/ERROR_KNOWLEDGE_BASE.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Log ƒë·∫ßy ƒë·ªß](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ü§ñ Action ti·∫øp theo:" >> $GITHUB_STEP_SUMMARY
          echo "1. Review file Knowledge Base" >> $GITHUB_STEP_SUMMARY
          echo "2. Ph√¢n t√≠ch nguy√™n nh√¢n l·ªói" >> $GITHUB_STEP_SUMMARY
          echo "3. C·∫≠p nh·∫≠t ph·∫ßn TODO trong entry" >> $GITHUB_STEP_SUMMARY
          echo "4. Th·ª≠ fix v√† commit k·∫øt qu·∫£" >> $GITHUB_STEP_SUMMARY

      - name: D·ªçn d·∫πp
        run: rm -rf current-log/ current-log.zip main-errors.txt error-context.txt
