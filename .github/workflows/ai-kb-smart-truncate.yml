name: AI Knowledge Base (Smart Truncate + Workflow YML)

on:
  workflow_run:
    workflows: ["*"]
    types: [completed]

permissions:
  actions: read
  contents: write

jobs:
  ai-analyze-error:
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      contains(github.event.workflow_run.name, 'ver') &&
      !contains(github.event.workflow_run.name, 'AI Knowledge Base')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Download and extract smart log
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -L \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/logs" \
            -o current-log.zip
          
          unzip -q current-log.zip -d current-log/
          find current-log/ -name "*.txt" -exec cat {} \; > full-log.txt
          
          TOTAL=$(wc -l < full-log.txt)
          echo "📊 Full log: $TOTAL lines"
          
          # Find exit code
          EXIT_LINE=$(grep -n "exit code [1-9]" full-log.txt | head -n 1 | cut -d: -f1)
          if [ -z "$EXIT_LINE" ]; then
            EXIT_LINE=$(grep -n "##\[error\]" full-log.txt | head -n 1 | cut -d: -f1)
          fi
          
          if [ -n "$EXIT_LINE" ]; then
            echo "✅ Exit code at line: $EXIT_LINE"
            
            # Extract 100 lines BEFORE exit code
            START=$((EXIT_LINE - 100))
            [ $START -lt 1 ] && START=1
            
            sed -n "${START},${EXIT_LINE}p" full-log.txt > context-100-lines.txt
            
            # Find first ERROR: line
            ERROR_LINE=$(grep -n "ERROR:\|error:" full-log.txt | head -n 1 | cut -d: -f1)
            
            if [ -n "$ERROR_LINE" ]; then
              echo "✅ Error at line: $ERROR_LINE"
              
              # Extract 20 lines BEFORE first error
              ERR_START=$((ERROR_LINE - 20))
              [ $ERR_START -lt 1 ] && ERR_START=1
              
              sed -n "${ERR_START},${ERROR_LINE}p" full-log.txt > error-20-lines.txt
            else
              # No ERROR: found, use last 20 lines
              tail -n 20 full-log.txt > error-20-lines.txt
            fi
          else
            # Fallback: no exit code found
            tail -n 100 full-log.txt > context-100-lines.txt
            tail -n 20 full-log.txt > error-20-lines.txt
          fi
          
          echo "📤 Context: $(wc -l < context-100-lines.txt) lines"
          echo "📤 Error: $(wc -l < error-20-lines.txt) lines"

      - name: Find workflow YML file
        id: find_yml
        run: |
          # Try to find workflow file by name
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          
          # Search in .github/workflows/
          FOUND_YML=$(find .github/workflows/ -name "*.yml" -o -name "*.yaml" | head -n 1)
          
          if [ -z "$FOUND_YML" ]; then
            echo "⚠️ No workflow file found"
            echo "yml_path=" >> $GITHUB_OUTPUT
          else
            echo "✅ Found workflow: $FOUND_YML"
            echo "yml_path=$FOUND_YML" >> $GITHUB_OUTPUT
          fi

      - name: Extract version
        id: extract_ver
        run: |
          VERSION=$(echo "${{ github.event.workflow_run.name }}" | grep -oE 'ver[0-9]+' || echo "ver-unknown")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Call Gemini with smart context
        id: ai_analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          YML_PATH: ${{ steps.find_yml.outputs.yml_path }}
        run: |
          # Create comprehensive prompt
          cat > analysis-prompt.txt << 'EOFPROMPT'
          Bạn là chuyên gia phân tích lỗi FFmpeg Android ARM32.
          
          WORKFLOW: Build FFmpeg Android ARM32 (Full Features + LibASS Added - ver8)
          VERSION: ver8
          
          CONTEXT:
          - ver8 đang build LibASS (subtitle renderer)
          - Thư viện OK: x264, x265, vpx, opus, lame, fribidi, fdk-aac, aom, soxr, webp, freetype
          
          Dưới đây là:
          1. 100 dòng TRƯỚC exit code (context đầy đủ)
          2. 20 dòng TRƯỚC dòng ERROR: đầu tiên
          3. Workflow YML file (nếu có)
          
          NHIỆM VỤ: Phân tích và trả về JSON NGẮN GỌN:
          {
            "error_id": "ERROR-XXX",
            "error_name": "Mô tả ngắn (max 10 từ)",
            "root_cause": "Nguyên nhân gốc (max 100 từ)",
            "affected_library": "libass",
            "error_type": "DEPENDENCY|LINKER|CONFIGURE|SYNTAX|UNKNOWN",
            "symptoms": ["triệu chứng chính"],
            "fix_suggestion": "Cách fix ngắn gọn (max 150 từ)",
            "confidence": 90
          }
          
          LƯU Ý: Trả về OBJECT {}, KHÔNG ARRAY
          
          ===== 1. CONTEXT (100 dòng trước exit code) =====
          
          EOFPROMPT
          
          cat context-100-lines.txt >> analysis-prompt.txt
          
          cat >> analysis-prompt.txt << 'EOFSEP'
          
          ===== 2. ERROR CONTEXT (20 dòng trước ERROR:) =====
          
          EOFSEP
          
          cat error-20-lines.txt >> analysis-prompt.txt
          
          # Add workflow YML if found
          if [ -n "$YML_PATH" ] && [ -f "$YML_PATH" ]; then
            cat >> analysis-prompt.txt << EOFYML
          
          ===== 3. WORKFLOW YML FILE =====
          
          EOFYML
            # Limit YML to 30KB to stay within token budget
            head -c 30000 "$YML_PATH" >> analysis-prompt.txt
          fi
          
          # Escape for JSON
          PROMPT_ESCAPED=$(jq -Rs . < analysis-prompt.txt)
          
          # Create payload
          cat > api-payload.json << EOFPAYLOAD
          {
            "contents": [{
              "parts": [{
                "text": $PROMPT_ESCAPED
              }]
            }],
            "generationConfig": {
              "temperature": 0.1,
              "maxOutputTokens": 2048,
              "responseMimeType": "application/json"
            }
          }
          EOFPAYLOAD
          
          echo "📤 Calling Gemini..."
          
          RESP=$(curl -s -w "\nHTTP:%{http_code}" -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            --data-binary @api-payload.json)
          
          HTTP=$(echo "$RESP" | tail -n 1 | cut -d: -f2)
          BODY=$(echo "$RESP" | sed '$d')
          
          echo "HTTP: $HTTP"
          
          if [ "$HTTP" != "200" ]; then
            echo "❌ API error"
            cat > ai-analysis.json << 'EOF'
          {"error_id":"ERROR-999","error_name":"API error","root_cause":"Gemini failed","affected_library":"unknown","error_type":"API_ERROR","symptoms":["API error"],"fix_suggestion":"Review log manually","confidence":20}
          EOF
          else
            AI=$(echo "$BODY" | jq -r '.candidates[0].content.parts[0].text')
            
            if [ -z "$AI" ] || [ "$AI" = "null" ]; then
              cat > ai-analysis.json << 'EOF'
          {"error_id":"ERROR-998","error_name":"Empty","root_cause":"Empty","affected_library":"unknown","error_type":"API_ERROR","symptoms":["Empty"],"fix_suggestion":"Retry","confidence":15}
          EOF
            else
              if echo "$AI" | jq -e 'type == "array"' > /dev/null 2>&1; then
                echo "$AI" | jq '.[0]' > ai-analysis.json
              else
                echo "$AI" > ai-analysis.json
              fi
              
              if ! jq empty ai-analysis.json 2>/dev/null; then
                cat > ai-analysis.json << 'EOF'
          {"error_id":"ERROR-997","error_name":"Invalid JSON","root_cause":"Parse error","affected_library":"unknown","error_type":"API_ERROR","symptoms":["Invalid"],"fix_suggestion":"Review","confidence":10}
          EOF
              fi
            fi
          fi
          
          cat ai-analysis.json
          
          echo "error_id=$(jq -r '.error_id // "ERROR-000"' ai-analysis.json)" >> $GITHUB_OUTPUT
          echo "error_name=$(jq -r '.error_name // "Unknown"' ai-analysis.json)" >> $GITHUB_OUTPUT
          echo "affected_lib=$(jq -r '.affected_library // "unknown"' ai-analysis.json)" >> $GITHUB_OUTPUT

      - name: Create summary file for repo
        id: create_summary
        run: |
          mkdir -p .github/error-summaries
          
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          SAFE_NAME=$(echo "$WORKFLOW_NAME" | sed 's/[^a-zA-Z0-9-]/_/g')
          RUN_NUM="${{ github.event.workflow_run.run_number }}"
          DATE=$(date +%Y%m%d-%H%M%S)
          
          SUMMARY_FILE="${SAFE_NAME}_run${RUN_NUM}_${DATE}.md"
          SUMMARY_PATH=".github/error-summaries/${SUMMARY_FILE}"
          
          # Create markdown summary
          cat > "$SUMMARY_PATH" << EOFSUMMARY
          # FFmpeg Build Error Summary
          
          ## Workflow Info
          
          - **Workflow:** ${{ github.event.workflow_run.name }}
          - **Run:** #${{ github.event.workflow_run.run_number }}
          - **Version:** ${{ steps.extract_ver.outputs.version }}
          - **Date:** $(date +%Y-%m-%d\ %H:%M:%S)
          - **GitHub URL:** https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}
          
          ## AI Analysis (Gemini 2.0 Flash)
          
          \`\`\`json
          $(cat ai-analysis.json)
          \`\`\`
          
          ### Error Details
          
          **Error ID:** $(jq -r '.error_id' ai-analysis.json)  
          **Error Name:** $(jq -r '.error_name' ai-analysis.json)  
          **Affected Library:** $(jq -r '.affected_library' ai-analysis.json)  
          **Error Type:** $(jq -r '.error_type' ai-analysis.json)  
          **Confidence:** $(jq -r '.confidence' ai-analysis.json)%
          
          **Symptoms:**
          $(jq -r '.symptoms | map("- " + .) | join("\n")' ai-analysis.json)
          
          **Root Cause:**
          $(jq -r '.root_cause' ai-analysis.json)
          
          **Fix Suggestion:**
          $(jq -r '.fix_suggestion' ai-analysis.json)
          
          ## Log Context (100 lines before exit code)
          
          \`\`\`
          $(cat context-100-lines.txt)
          \`\`\`
          
          ## Error Context (20 lines before ERROR:)
          
          \`\`\`
          $(cat error-20-lines.txt)
          \`\`\`
          
          ---
          
          **For Perplexity:** Read this summary and suggest detailed fix steps.
          EOFSUMMARY
          
          echo "summary_file=$SUMMARY_FILE" >> $GITHUB_OUTPUT
          echo "✅ Created summary: $SUMMARY_FILE"

      - name: Init KB
        run: |
          if [ ! -f .github/ERROR_KNOWLEDGE_BASE.md ]; then
            cat > .github/ERROR_KNOWLEDGE_BASE.md << 'EOF'
          # 📚 FFmpeg Android ARM32 - Error Knowledge Base
          
          > **AI:** Gemini with smart log truncation (100+20 lines) + Workflow YML  
          > **Total:** 0
          
          ## 📋 Quick Reference
          
          | ID | Error | Library | Ver | Summary | Date |
          |----|-------|---------|-----|---------|------|
          
          ## 🔴 Details
          
          EOF
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .github/ERROR_KNOWLEDGE_BASE.md
            git commit -m "docs: Init KB"
          fi

      - name: Add entry
        env:
          ERROR_ID: ${{ steps.ai_analysis.outputs.error_id }}
          ERROR_NAME: ${{ steps.ai_analysis.outputs.error_name }}
          AFFECTED_LIB: ${{ steps.ai_analysis.outputs.affected_lib }}
          VERSION: ${{ steps.extract_ver.outputs.version }}
          SUMMARY_FILE: ${{ steps.create_summary.outputs.summary_file }}
        run: |
          JSON=$(cat ai-analysis.json)
          ROOT=$(echo "$JSON" | jq -r '.root_cause // "N/A"')
          TYPE=$(echo "$JSON" | jq -r '.error_type // "UNKNOWN"')
          FIX=$(echo "$JSON" | jq -r '.fix_suggestion // "N/A"')
          SYMP=$(echo "$JSON" | jq -r '.symptoms // ["N/A"] | join(", ")')
          CONF=$(echo "$JSON" | jq -r '.confidence // 0')
          
          sed -i "/^| ID/a | $ERROR_ID | $ERROR_NAME | $AFFECTED_LIB | $VERSION | [\`$SUMMARY_FILE\`](.github/error-summaries/$SUMMARY_FILE) | $(date +%Y-%m-%d) |" .github/ERROR_KNOWLEDGE_BASE.md
          
          TOTAL=$(grep -c "^### 🔴" .github/ERROR_KNOWLEDGE_BASE.md 2>/dev/null || echo "0")
          NEW=$((TOTAL + 1))
          sed -i "s/Total:\*\* [0-9]*/Total:** $NEW/" .github/ERROR_KNOWLEDGE_BASE.md
          
          cat >> .github/ERROR_KNOWLEDGE_BASE.md << EOF
          
          ### 🔴 $ERROR_ID: $ERROR_NAME
          
          **📅** $(date +%Y-%m-%d) | **🔗** [Run #${{ github.event.workflow_run.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})  
          **🎯** \`$AFFECTED_LIB\` | **🏷️** \`$VERSION\` | **🤖** ${CONF}%
          
          **📄 Full Summary:** [\`.github/error-summaries/$SUMMARY_FILE\`](.github/error-summaries/$SUMMARY_FILE)
          
          **⚠️** $SYMP
          
          **🔍** $ROOT
          
          **🛠️** $FIX
          
          **📝** \`$TYPE\`
          
          ---
          
          EOF

      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/error-summaries/ .github/ERROR_KNOWLEDGE_BASE.md
          if ! git diff --staged --quiet; then
            git commit -m "🤖 ${{ steps.ai_analysis.outputs.error_id }} [${{ steps.extract_ver.outputs.version }}] Summary"
            git push
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ✅ Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Ver:** ${{ steps.extract_ver.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Error:** ${{ steps.ai_analysis.outputs.error_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Summary:** \`.github/error-summaries/${{ steps.create_summary.outputs.summary_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🤖 Gemini Analysis:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          cat ai-analysis.json
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "💡 **For Perplexity:** Read \`.github/error-summaries/${{ steps.create_summary.outputs.summary_file }}\` and suggest fix" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: rm -rf current-log/ current-log.zip full-log.txt context-100-lines.txt error-20-lines.txt analysis-prompt.txt api-payload.json ai-analysis.json 2>/dev/null || true
