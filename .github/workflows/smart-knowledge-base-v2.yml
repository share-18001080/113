name: Smart Knowledge Base v2 (Error Handling)

on:
  workflow_run:
    workflows: ["*"]
    types: [completed]

permissions:
  actions: read
  contents: write

jobs:
  ai-analyze-error:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: T·∫£i log workflow b·ªã l·ªói
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID=${{ github.event.workflow_run.id }}
          
          curl -L \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/runs/${RUN_ID}/logs \
            -o current-log.zip
          
          unzip -q current-log.zip -d current-log/
          find current-log/ -name "*.txt" -exec cat {} \; > full-log.txt
          
          # Gi·∫£m log xu·ªëng 20KB ƒë·ªÉ tr√°nh v∆∞·ª£t token limit
          tail -n 5000 full-log.txt > log-for-ai.txt

      - name: Chu·∫©n b·ªã context cho AI (ng·∫Øn g·ªçn h∆°n)
        run: |
          cat > context.txt << 'EOFCONTEXT'
          B·∫°n l√† chuy√™n gia ph√¢n t√≠ch l·ªói FFmpeg Android build.

          WORKFLOW: ${{ github.event.workflow_run.name }}
          RUN: #${{ github.event.workflow_run.run_number }}
          
          NHI·ªÜM V·ª§:
          Ph√¢n t√≠ch log l·ªói v√† tr·∫£ v·ªÅ JSON format:
          {
            "error_id": "ERROR-XXX",
            "error_name": "M√¥ t·∫£ ng·∫Øn g·ªçn",
            "root_cause": "Nguy√™n nh√¢n g·ªëc",
            "affected_library": "libass",
            "error_type": "DEPENDENCY",
            "symptoms": ["l·ªói 1", "l·ªói 2"],
            "fix_suggestion": "C√°ch fix",
            "confidence": 90
          }
          
          QUAN TR·ªåNG: Ch·ªâ tr·∫£ v·ªÅ JSON, kh√¥ng th√™m markdown hay text kh√°c.
          EOFCONTEXT

      - name: Test Gemini API Key
        id: test_api
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "‚ùå ERROR: GEMINI_API_KEY ch∆∞a ƒë∆∞·ª£c set!"
            echo "api_key_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Test API v·ªõi request ƒë∆°n gi·∫£n
          TEST_RESPONSE=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"contents":[{"parts":[{"text":"Hello"}]}]}')
          
          if echo "$TEST_RESPONSE" | grep -q "error"; then
            echo "‚ùå API Key kh√¥ng h·ª£p l·ªá ho·∫∑c c√≥ l·ªói:"
            echo "$TEST_RESPONSE"
            echo "api_key_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ API Key h·ª£p l·ªá"
          echo "api_key_valid=true" >> $GITHUB_OUTPUT

      - name: G·ªçi Gemini API (v·ªõi error handling)
        id: ai_analysis
        if: steps.test_api.outputs.api_key_valid == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # Gi·∫£m size log ƒë·ªÉ tr√°nh v∆∞·ª£t token limit (20KB max)
          LOG_CONTENT=$(head -c 20000 log-for-ai.txt | base64 -w 0)
          CONTEXT=$(cat context.txt | base64 -w 0)
          
          echo "üì§ G·ª≠i request t·ªõi Gemini API..."
          
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"contents\": [{
                \"parts\": [{
                  \"text\": \"$(echo "$CONTEXT" | base64 -d)\n\nLog (base64): $LOG_CONTENT\"
                }]
              }],
              \"generationConfig\": {
                \"temperature\": 0.1,
                \"maxOutputTokens\": 1024
              }
            }")
          
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå API tr·∫£ v·ªÅ l·ªói (HTTP $HTTP_CODE):"
            echo "$RESPONSE_BODY" | jq .
            
            # Fallback: Ph√¢n t√≠ch th√¥ b·∫±ng grep
            echo "‚ö†Ô∏è Fallback: S·ª≠ d·ª•ng ph√¢n t√≠ch th√¥"
            
            FIRST_ERROR=$(grep -m 1 "error:" log-for-ai.txt || echo "Unknown error")
            
            cat > ai-analysis.json << EOFJSON
          {
            "error_id": "ERROR-999",
            "error_name": "Gemini API failed - Using fallback",
            "root_cause": "$FIRST_ERROR",
            "affected_library": "unknown",
            "error_type": "UNKNOWN",
            "symptoms": ["$FIRST_ERROR"],
            "fix_suggestion": "C·∫ßn ph√¢n t√≠ch th·ªß c√¥ng - Gemini API kh√¥ng kh·∫£ d·ª•ng",
            "confidence": 30
          }
          EOFJSON
          else
            # Parse response
            AI_RESULT=$(echo "$RESPONSE_BODY" | jq -r '.candidates[0].content.parts[0].text' 2>/dev/null || echo "null")
            
            if [ "$AI_RESULT" = "null" ] || [ -z "$AI_RESULT" ]; then
              echo "‚ùå Gemini kh√¥ng tr·∫£ v·ªÅ text h·ª£p l·ªá"
              echo "Response: $RESPONSE_BODY" | jq .
              
              # Fallback
              FIRST_ERROR=$(grep -m 1 "error:" log-for-ai.txt || echo "Parse error")
              
              cat > ai-analysis.json << EOFJSON
          {
            "error_id": "ERROR-998",
            "error_name": "Response parsing failed",
            "root_cause": "$FIRST_ERROR",
            "affected_library": "unknown",
            "error_type": "UNKNOWN",
            "symptoms": ["Response null or empty"],
            "fix_suggestion": "Check API response format",
            "confidence": 20
          }
          EOFJSON
            else
              echo "‚úÖ Nh·∫≠n ƒë∆∞·ª£c response t·ª´ Gemini"
              echo "$AI_RESULT"
              
              # Tr√≠ch xu·∫•t JSON t·ª´ response
              AI_JSON=$(echo "$AI_RESULT" | grep -Eo '\{[^}]+\}' | head -n 1)
              
              if [ -z "$AI_JSON" ]; then
                echo "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y JSON trong response, l∆∞u raw text"
                echo "$AI_RESULT" > ai-analysis.json
              else
                echo "$AI_JSON" > ai-analysis.json
              fi
            fi
          fi
          
          # Validate JSON
          if ! jq empty ai-analysis.json 2>/dev/null; then
            echo "‚ùå JSON kh√¥ng h·ª£p l·ªá, t·∫°o fallback"
            
            cat > ai-analysis.json << EOFJSON
          {
            "error_id": "ERROR-997",
            "error_name": "JSON validation failed",
            "root_cause": "AI response kh√¥ng parse ƒë∆∞·ª£c",
            "affected_library": "unknown",
            "error_type": "UNKNOWN",
            "symptoms": ["Invalid JSON from Gemini"],
            "fix_suggestion": "Manual analysis required",
            "confidence": 10
          }
          EOFJSON
          fi
          
          cat ai-analysis.json
          
          # Extract fields
          echo "error_id=$(jq -r '.error_id // "ERROR-000"' ai-analysis.json)" >> $GITHUB_OUTPUT
          echo "error_name=$(jq -r '.error_name // "Unknown Error"' ai-analysis.json)" >> $GITHUB_OUTPUT
          echo "affected_lib=$(jq -r '.affected_library // "unknown"' ai-analysis.json)" >> $GITHUB_OUTPUT

      - name: Kh·ªüi t·∫°o Knowledge Base n·∫øu ch∆∞a c√≥
        run: |
          if [ ! -f .github/ERROR_KNOWLEDGE_BASE.md ]; then
            echo "# üìö FFmpeg Android ARM32 - Error Knowledge Base" > .github/ERROR_KNOWLEDGE_BASE.md
            echo "" >> .github/ERROR_KNOWLEDGE_BASE.md
            echo "> **C·∫≠p nh·∫≠t:** T·ª± ƒë·ªông b·ªüi AI (Gemini 2.0 Flash)" >> .github/ERROR_KNOWLEDGE_BASE.md
            echo "> **T·ªïng s·ªë l·ªói:** 0" >> .github/ERROR_KNOWLEDGE_BASE.md
            echo "" >> .github/ERROR_KNOWLEDGE_BASE.md
            echo "---" >> .github/ERROR_KNOWLEDGE_BASE.md
            echo "" >> .github/ERROR_KNOWLEDGE_BASE.md
            echo "## üìã Quick Reference" >> .github/ERROR_KNOWLEDGE_BASE.md
            echo "" >> .github/ERROR_KNOWLEDGE_BASE.md
            echo "| ID | T√™n l·ªói | Th∆∞ vi·ªán | Workflow | Ng√†y |" >> .github/ERROR_KNOWLEDGE_BASE.md
            echo "|----|---------|----------|----------|------|" >> .github/ERROR_KNOWLEDGE_BASE.md
            echo "" >> .github/ERROR_KNOWLEDGE_BASE.md
            echo "---" >> .github/ERROR_KNOWLEDGE_BASE.md
            echo "" >> .github/ERROR_KNOWLEDGE_BASE.md
            echo "## üî¥ Chi ti·∫øt l·ªói" >> .github/ERROR_KNOWLEDGE_BASE.md
            
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .github/ERROR_KNOWLEDGE_BASE.md
            git commit -m "docs: Kh·ªüi t·∫°o Error Knowledge Base"
          fi

      - name: Th√™m entry v√†o Knowledge Base
        env:
          ERROR_ID: ${{ steps.ai_analysis.outputs.error_id }}
          ERROR_NAME: ${{ steps.ai_analysis.outputs.error_name }}
          AFFECTED_LIB: ${{ steps.ai_analysis.outputs.affected_lib }}
        run: |
          AI_JSON=$(cat ai-analysis.json)
          
          ROOT_CAUSE=$(echo "$AI_JSON" | jq -r '.root_cause // "N/A"')
          ERROR_TYPE=$(echo "$AI_JSON" | jq -r '.error_type // "UNKNOWN"')
          FIX_SUGGESTION=$(echo "$AI_JSON" | jq -r '.fix_suggestion // "N/A"')
          SYMPTOMS=$(echo "$AI_JSON" | jq -r '.symptoms // ["N/A"] | join("\n")')
          CONFIDENCE=$(echo "$AI_JSON" | jq -r '.confidence // 0')
          
          sed -i "/^| ID | T√™n l·ªói/a | $ERROR_ID | $ERROR_NAME | $AFFECTED_LIB | ${{ github.event.workflow_run.name }} | $(date +%Y-%m-%d) |" .github/ERROR_KNOWLEDGE_BASE.md
          
          TOTAL_ERRORS=$(grep -c "^### üî¥ ERROR-" .github/ERROR_KNOWLEDGE_BASE.md || echo "0")
          NEW_TOTAL=$((TOTAL_ERRORS + 1))
          sed -i "s/\*\*T·ªïng s·ªë l·ªói:\*\* [0-9]*/\*\*T·ªïng s·ªë l·ªói:\*\* $NEW_TOTAL/" .github/ERROR_KNOWLEDGE_BASE.md
          
          echo "" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "### üî¥ $ERROR_ID: $ERROR_NAME" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "**üìÖ Ng√†y:** $(date +%Y-%m-%d)" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "**üì¶ Workflow:** ${{ github.event.workflow_run.name }} [Run #${{ github.event.workflow_run.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "**üéØ Th∆∞ vi·ªán:** \`$AFFECTED_LIB\`" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "**ü§ñ ƒê·ªô tin c·∫≠y:** ${CONFIDENCE}%" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "**‚ö†Ô∏è Tri·ªáu ch·ª©ng:**" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "\`\`\`" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "$SYMPTOMS" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "\`\`\`" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "**üîç Nguy√™n nh√¢n:**" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "$ROOT_CAUSE" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "**üõ†Ô∏è Fix:**" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "$FIX_SUGGESTION" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "**üìù Lo·∫°i:** \`$ERROR_TYPE\`" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "" >> .github/ERROR_KNOWLEDGE_BASE.md
          echo "---" >> .github/ERROR_KNOWLEDGE_BASE.md

      - name: Commit v√† push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .github/ERROR_KNOWLEDGE_BASE.md
          
          if git diff --staged --quiet; then
            echo "Kh√¥ng c√≥ thay ƒë·ªïi"
          else
            git commit -m "ü§ñ ${{ steps.ai_analysis.outputs.error_id }}: ${{ steps.ai_analysis.outputs.error_name }}"
            git push
          fi

      - name: Debug info
        if: always()
        run: |
          echo "## üîç Debug Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API Key Set:** ${{ steps.test_api.outputs.api_key_valid }}" >> $GITHUB_STEP_SUMMARY
          echo "**Error ID:** ${{ steps.ai_analysis.outputs.error_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Error Name:** ${{ steps.ai_analysis.outputs.error_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### AI Analysis JSON:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          cat ai-analysis.json >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: D·ªçn d·∫πp
        if: always()
        run: rm -rf current-log/ current-log.zip full-log.txt log-for-ai.txt context.txt ai-analysis.json
