name: AI Knowledge Base (Perplexity Optimized)

on:
  workflow_run:
    workflows: ["*"]
    types: [completed]

permissions:
  actions: read
  contents: write

jobs:
  ai-analyze-error:
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      contains(github.event.workflow_run.name, 'ver') &&
      !contains(github.event.workflow_run.name, 'AI Knowledge Base')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Download and analyze log
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -L \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/logs" \
            -o current-log.zip
          
          unzip -q current-log.zip -d current-log/
          find current-log/ -name "*.txt" -exec cat {} \; > full-log.txt
          
          TOTAL=$(wc -l < full-log.txt)
          echo "ðŸ“Š Total: $TOTAL lines"
          
          # Find exit code
          EXIT_LINE=$(grep -n "exit code [1-9]" full-log.txt | head -n 1 | cut -d: -f1)
          [ -z "$EXIT_LINE" ] && EXIT_LINE=$(grep -n "##\[error\]" full-log.txt | head -n 1 | cut -d: -f1)
          
          if [ -n "$EXIT_LINE" ]; then
            START=$((EXIT_LINE - 20))
            [ $START -lt 1 ] && START=1
            sed -n "${START},${EXIT_LINE}p" full-log.txt > error-context-20.txt
            
            # Find detail log reference
            DETAIL_LOG_PATH=$(grep -o "A full log can be found at .*" error-context-20.txt | head -n 1 | sed 's/A full log can be found at //' | tr -d '\r\n ')
            
            if [ -n "$DETAIL_LOG_PATH" ]; then
              echo "âœ… Detail log: $DETAIL_LOG_PATH"
              echo "$DETAIL_LOG_PATH" > detail-log-path.txt
              
              # Try extract detail log content
              DETAIL_LOG_NAME=$(basename "$DETAIL_LOG_PATH")
              if grep -q "$DETAIL_LOG_NAME" full-log.txt; then
                grep -A 100 "$DETAIL_LOG_NAME" full-log.txt | head -n 100 > detail-log-content.txt
              else
                touch detail-log-content.txt
              fi
            else
              touch detail-log-path.txt
              touch detail-log-content.txt
            fi
          else
            tail -n 20 full-log.txt > error-context-20.txt
            touch detail-log-path.txt
            touch detail-log-content.txt
          fi

      - name: Extract version
        id: extract_ver
        run: |
          VERSION=$(echo "${{ github.event.workflow_run.name }}" | grep -oE 'ver[0-9]+' || echo "unknown")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Call Gemini with Retry Logic
        id: ai_analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          HAS_DETAIL=$([ -s detail-log-content.txt ] && echo "yes" || echo "no")
          
          # Create prompt using echo (avoid heredoc)
          echo "PhÃ¢n tÃ­ch lá»—i FFmpeg Android ARM32 ver8 (LibASS)." > prompt.txt
          echo "Tráº£ vá» JSON OBJECT (KHÃ”NG ARRAY):" >> prompt.txt
          echo "" >> prompt.txt
          echo "{" >> prompt.txt
          echo '"error_id": "ERROR-XXX",' >> prompt.txt
          echo '"error_name": "MÃ´ táº£ ngáº¯n (max 10 tá»«)",' >> prompt.txt
          echo '"root_cause": "NguyÃªn nhÃ¢n (max 100 tá»«)",' >> prompt.txt
          echo '"affected_library": "libass",' >> prompt.txt
          echo '"error_type": "DEPENDENCY|LINKER|CONFIGURE|SYNTAX|UNKNOWN",' >> prompt.txt
          echo '"symptoms": ["triá»‡u chá»©ng"],' >> prompt.txt
          echo '"fix_suggestion": "CÃ¡ch fix (max 150 tá»«)",' >> prompt.txt
          echo '"confidence": 90' >> prompt.txt
          echo "}" >> prompt.txt
          echo "" >> prompt.txt
          echo "===== ERROR CONTEXT (20 dÃ²ng trÆ°á»›c exit code) =====" >> prompt.txt
          cat error-context-20.txt >> prompt.txt
          
          if [ "$HAS_DETAIL" = "yes" ]; then
            echo "===== DETAIL LOG =====" >> prompt.txt
            cat detail-log-content.txt >> prompt.txt
          fi
          
          # Retry logic for Gemini API
          MAX_RETRIES=5
          RETRY_COUNT=0
          SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
            echo "ðŸ”„ Gemini API attempt $((RETRY_COUNT + 1))/$MAX_RETRIES"
            
            ESCAPED=$(jq -Rs . < prompt.txt)
            
            # Create payload using echo
            echo "{" > payload.json
            echo '  "contents": [' >> payload.json
            echo '    {' >> payload.json
            echo '      "parts": [' >> payload.json
            echo "        {\"text\": $ESCAPED}" >> payload.json
            echo '      ]' >> payload.json
            echo '    }' >> payload.json
            echo '  ],' >> payload.json
            echo '  "generationConfig": {' >> payload.json
            echo '    "temperature": 0.1,' >> payload.json
            echo '    "maxOutputTokens": 2048,' >> payload.json
            echo '    "responseMimeType": "application/json"' >> payload.json
            echo '  }' >> payload.json
            echo '}' >> payload.json
            
            # API call with timeout
            RESP=$(timeout 30 curl -s -w "\nHTTP:%{http_code}" -X POST \
              "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=$GEMINI_API_KEY" \
              -H "Content-Type: application/json" \
              --data-binary @payload.json 2>/dev/null)
            
            CURL_EXIT=$?
            
            if [ $CURL_EXIT -eq 0 ]; then
              HTTP=$(echo "$RESP" | tail -n 1 | cut -d: -f2)
              BODY=$(echo "$RESP" | sed '$d')
              
              if [ "$HTTP" = "200" ]; then
                AI=$(echo "$BODY" | jq -r '.candidates[0].content.parts[0].text' 2>/dev/null)
                
                if [ -n "$AI" ] && [ "$AI" != "null" ] && [ "$AI" != "" ]; then
                  # Validate JSON
                  if echo "$AI" | jq . >/dev/null 2>&1; then
                    echo "âœ… Gemini API success on attempt $((RETRY_COUNT + 1))"
                    
                    # Handle array vs object
                    if echo "$AI" | jq -e 'type == "array"' > /dev/null 2>&1; then
                      echo "$AI" | jq '.[0]' > ai.json
                    else
                      echo "$AI" > ai.json
                    fi
                    
                    SUCCESS=true
                  else
                    echo "âŒ Invalid JSON response, retrying..."
                  fi
                else
                  echo "âŒ Empty AI response, retrying..."
                fi
              elif [ "$HTTP" = "429" ]; then
                echo "â³ Rate limited, waiting $((RETRY_COUNT * 10 + 10))s..."
                sleep $((RETRY_COUNT * 10 + 10))
              elif [ "$HTTP" = "500" ] || [ "$HTTP" = "502" ] || [ "$HTTP" = "503" ]; then
                echo "ðŸ”´ Server error $HTTP, waiting $((RETRY_COUNT * 5 + 5))s..."
                sleep $((RETRY_COUNT * 5 + 5))
              else
                echo "âŒ HTTP $HTTP: $(echo "$BODY" | head -n 3)"
              fi
            else
              echo "âŒ Network error (curl exit $CURL_EXIT)"
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            
            # Progressive delay
            if [ "$SUCCESS" = "false" ] && [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              DELAY=$((RETRY_COUNT * 3))
              echo "â±ï¸ Waiting ${DELAY}s before retry..."
              sleep $DELAY
            fi
          done
          
          # Fallback if all retries failed
          if [ "$SUCCESS" = "false" ]; then
            echo "ðŸ’¥ All Gemini API attempts failed, using fallback"
            echo "{" > ai.json
            echo '  "error_id": "ERROR-999",' >> ai.json
            echo '  "error_name": "API Failed After Retries",' >> ai.json
            echo '  "root_cause": "Gemini API khÃ´ng pháº£n há»“i sau ' >> ai.json
            echo $MAX_RETRIES >> ai.json
            echo ' láº§n thá»­",' >> ai.json
            echo '  "affected_library": "unknown",' >> ai.json
            echo '  "error_type": "API_ERROR",' >> ai.json
            echo '  "symptoms": ["API timeout", "Network error"],' >> ai.json
            echo '  "fix_suggestion": "Kiá»ƒm tra láº¡i API key hoáº·c thá»­ láº¡i sau",' >> ai.json
            echo '  "confidence": 10' >> ai.json
            echo '}' >> ai.json
          fi
          
          cat ai.json
          echo "error_id=$(jq -r '.error_id // "ERROR-000"' ai.json)" >> $GITHUB_OUTPUT
          echo "error_name=$(jq -r '.error_name // "Unknown"' ai.json)" >> $GITHUB_OUTPUT
          echo "affected_lib=$(jq -r '.affected_library // "unknown"' ai.json)" >> $GITHUB_OUTPUT

      - name: Create Perplexity-friendly structure
        id: create_files
        run: |
          # Create logs directory structure (with spaces for SEO)
          mkdir -p "logs/Error Summaries"
          mkdir -p "logs/Detail Logs"
          
          # Generate filenames with spaces (Perplexity-friendly)
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          CLEAN_NAME=$(echo "$WORKFLOW_NAME" | sed 's/[()]//g' | sed 's/[^a-zA-Z0-9 -]/ /g' | sed 's/ */ /g' | xargs)
          RUN_NUM="${{ github.event.workflow_run.run_number }}"
          DATE=$(date +%Y%m%d)
          VERSION="${{ steps.extract_ver.outputs.version }}"
          
          SUMMARY_FILE="$CLEAN_NAME run$RUN_NUM $DATE.md"
          SUMMARY_PATH="logs/Error Summaries/$SUMMARY_FILE"
          
          # Create summary markdown using echo
          DETAIL_LOG=$(cat detail-log-path.txt)
          
          echo "# FFmpeg Build Error Summary" > "$SUMMARY_PATH"
          echo "" >> "$SUMMARY_PATH"
          echo "## Workflow Info" >> "$SUMMARY_PATH"
          echo "" >> "$SUMMARY_PATH"
          echo "- **Name:** ${{ github.event.workflow_run.name }}" >> "$SUMMARY_PATH"
          echo "- **Run:** #${{ github.event.workflow_run.run_number }}" >> "$SUMMARY_PATH"
          echo "- **Version:** $VERSION" >> "$SUMMARY_PATH"
          
          # FIX: Sá»­ dá»¥ng biáº¿n Ä‘á»ƒ trÃ¡nh nested quotes
          CURRENT_DATE=$(date '+%Y-%m-%d %H:%M:%S')
          echo "- **Date:** $CURRENT_DATE" >> "$SUMMARY_PATH"
          
          echo "- **Status:** Failed" >> "$SUMMARY_PATH"
          echo "- **GitHub:** https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}" >> "$SUMMARY_PATH"
          echo "" >> "$SUMMARY_PATH"
          echo "## AI Analysis (Gemini 2.0 Flash)" >> "$SUMMARY_PATH"
          echo "" >> "$SUMMARY_PATH"
          echo "\`\`\`json" >> "$SUMMARY_PATH"
          cat ai.json >> "$SUMMARY_PATH"
          echo "\`\`\`" >> "$SUMMARY_PATH"
          echo "" >> "$SUMMARY_PATH"
          echo "### Error Details" >> "$SUMMARY_PATH"
          echo "" >> "$SUMMARY_PATH"
          
          # FIX: Sá»­ dá»¥ng biáº¿n thay vÃ¬ printf vá»›i nested quotes
          ERROR_ID=$(jq -r '.error_id' ai.json)
          ERROR_NAME=$(jq -r '.error_name' ai.json)
          AFFECTED_LIBRARY=$(jq -r '.affected_library' ai.json)
          ERROR_TYPE=$(jq -r '.error_type' ai.json)
          CONFIDENCE=$(jq -r '.confidence' ai.json)
          
          echo "**Error ID:** $ERROR_ID" >> "$SUMMARY_PATH"
          echo "**Error Name:** $ERROR_NAME" >> "$SUMMARY_PATH"
          echo "**Affected Library:** $AFFECTED_LIBRARY" >> "$SUMMARY_PATH"
          echo "**Error Type:** $ERROR_TYPE" >> "$SUMMARY_PATH"
          echo "**AI Confidence:** ${CONFIDENCE}%" >> "$SUMMARY_PATH"
          echo "" >> "$SUMMARY_PATH"
          echo "**Symptoms:**" >> "$SUMMARY_PATH"
          echo "" >> "$SUMMARY_PATH"
          jq -r '.symptoms | map("- " + .) | join("\n")' ai.json >> "$SUMMARY_PATH"
          echo "" >> "$SUMMARY_PATH"
          echo "**Root Cause:**" >> "$SUMMARY_PATH"
          echo "" >> "$SUMMARY_PATH"
          jq -r '.root_cause' ai.json >> "$SUMMARY_PATH"
          echo "" >> "$SUMMARY_PATH"
          echo "**Fix Suggestion:**" >> "$SUMMARY_PATH"
          echo "" >> "$SUMMARY_PATH"
          jq -r '.fix_suggestion' ai.json >> "$SUMMARY_PATH"
          echo "" >> "$SUMMARY_PATH"
          echo "## Error Context (20 lines before exit code)" >> "$SUMMARY_PATH"
          echo "" >> "$SUMMARY_PATH"
          echo "\`\`\`" >> "$SUMMARY_PATH"
          cat error-context-20.txt >> "$SUMMARY_PATH"
          echo "\`\`\`" >> "$SUMMARY_PATH"
          echo "" >> "$SUMMARY_PATH"
          
          if [ -n "$DETAIL_LOG" ]; then
            echo "## Detail Log Reference" >> "$SUMMARY_PATH"
            echo "" >> "$SUMMARY_PATH"
            echo "\`\`\`" >> "$SUMMARY_PATH"
            echo "$DETAIL_LOG" >> "$SUMMARY_PATH"
            echo "\`\`\`" >> "$SUMMARY_PATH"
            
            if [ -s detail-log-content.txt ]; then
              echo "" >> "$SUMMARY_PATH"
              echo "### Detail Log Content" >> "$SUMMARY_PATH"
              echo "" >> "$SUMMARY_PATH"
              echo "\`\`\`" >> "$SUMMARY_PATH"
              cat detail-log-content.txt >> "$SUMMARY_PATH"
              echo "\`\`\`" >> "$SUMMARY_PATH"
            fi
          fi
          
          echo "" >> "$SUMMARY_PATH"
          echo "---" >> "$SUMMARY_PATH"
          echo "" >> "$SUMMARY_PATH"
          echo "**For Perplexity:** Read this summary in the \`logs/Error Summaries/\` folder and suggest detailed fix steps." >> "$SUMMARY_PATH"
          
          # Save detail log if exists
          if [ -s detail-log-content.txt ]; then
            DETAIL_FILE="$(basename "$DETAIL_LOG" | sed 's/\.txt//') $VERSION run$RUN_NUM.txt"
            cp detail-log-content.txt "logs/Detail Logs/$DETAIL_FILE"
            echo "detail_file=$DETAIL_FILE" >> $GITHUB_OUTPUT
          else
            echo "detail_file=" >> $GITHUB_OUTPUT
          fi
          
          echo "summary_file=$SUMMARY_FILE" >> $GITHUB_OUTPUT
          echo "âœ… Created: $SUMMARY_FILE"

      - name: Update Knowledge Base
        run: |
          KB_FILE="logs/Error Knowledge Base.md"
          
          # Create KB if not exists using echo
          if [ ! -f "$KB_FILE" ]; then
            echo "# FFmpeg Android ARM32 - Error Knowledge Base" > "$KB_FILE"
            echo "" >> "$KB_FILE"
            echo "> **Purpose:** Track all build errors for FFmpeg Android ARM32" >> "$KB_FILE"
            echo "> **AI:** Gemini 2.0 Flash with detail log analysis" >> "$KB_FILE"
            echo "> **Storage:** All logs in \`/logs/\` folder (Perplexity-optimized)" >> "$KB_FILE"
            echo "> **Total Errors:** 0" >> "$KB_FILE"
            echo "" >> "$KB_FILE"
            echo "## Quick Reference" >> "$KB_FILE"
            echo "" >> "$KB_FILE"
            echo "| ID | Error | Library | Version | Summary | Date |" >> "$KB_FILE"
            echo "|----|-------|---------|---------|---------|------|" >> "$KB_FILE"
            echo "" >> "$KB_FILE"
            echo "## Error Details" >> "$KB_FILE"
            echo "" >> "$KB_FILE"
          fi
          
          # Extract data
          ERROR_ID="${{ steps.ai_analysis.outputs.error_id }}"
          ERROR_NAME="${{ steps.ai_analysis.outputs.error_name }}"
          AFFECTED_LIB="${{ steps.ai_analysis.outputs.affected_lib }}"
          VERSION="${{ steps.extract_ver.outputs.version }}"
          SUMMARY_FILE="${{ steps.create_files.outputs.summary_file }}"
          DETAIL_FILE="${{ steps.create_files.outputs.detail_file }}"
          ROOT=$(jq -r '.root_cause // "N/A"' ai.json)
          TYPE=$(jq -r '.error_type // "UNKNOWN"' ai.json)
          FIX=$(jq -r '.fix_suggestion // "N/A"' ai.json)
          SYMP=$(jq -r '.symptoms // ["N/A"] | join(", ")' ai.json)
          CONF=$(jq -r '.confidence // 0' ai.json)
          
          # Update table
          sed -i "/^| ID | Error/a | $ERROR_ID | $ERROR_NAME | $AFFECTED_LIB | $VERSION | [\`$SUMMARY_FILE\`](Error Summaries/$SUMMARY_FILE) | $(date +%Y-%m-%d) |" "$KB_FILE"
          
          # Update total count (FIXED)
          TOTAL=$(grep -c "^### ðŸ”´" "$KB_FILE" 2>/dev/null | head -n 1 | tr -d '\n\r ' || echo "0")
          NEW=$((TOTAL + 1))
          sed -i "s/Total Errors:\*\* [0-9]*/Total Errors:** $NEW/" "$KB_FILE"
          
          # Add detail entry using echo
          echo "" >> "$KB_FILE"
          echo "### ðŸ”´ $ERROR_ID: $ERROR_NAME" >> "$KB_FILE"
          echo "" >> "$KB_FILE"
          
          # FIX: Sá»­ dá»¥ng biáº¿n Ä‘á»ƒ trÃ¡nh nested quotes
          CURRENT_DATE=$(date +%Y-%m-%d)
          echo "**ðŸ“… Date:** $CURRENT_DATE" >> "$KB_FILE"
          
          echo "**ðŸ”— GitHub:** [Run #${{ github.event.workflow_run.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})" >> "$KB_FILE"
          echo "**ðŸŽ¯ Library:** \`$AFFECTED_LIB\`" >> "$KB_FILE"
          echo "**ðŸ·ï¸ Version:** \`$VERSION\`" >> "$KB_FILE"
          echo "**ðŸ¤– AI Confidence:** ${CONF}%" >> "$KB_FILE"
          echo "**ðŸ“„ Full Summary:** [\`$SUMMARY_FILE\`](Error Summaries/$SUMMARY_FILE)" >> "$KB_FILE"
          
          if [ -n "$DETAIL_FILE" ]; then
            echo "**ðŸ“‹ Detail Log:** [\`$DETAIL_FILE\`](Detail Logs/$DETAIL_FILE)" >> "$KB_FILE"
          fi
          
          echo "**âš ï¸ Symptoms:** $SYMP" >> "$KB_FILE"
          echo "**ðŸ” Root Cause:** $ROOT" >> "$KB_FILE"
          echo "**ðŸ› ï¸ Fix Suggestion:** $FIX" >> "$KB_FILE"
          echo "**ðŸ“ Type:** \`$TYPE\`" >> "$KB_FILE"
          echo "" >> "$KB_FILE"
          echo "---" >> "$KB_FILE"
          echo "" >> "$KB_FILE"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add logs/
          
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ¤– ${{ steps.ai_analysis.outputs.error_id }}: ${{ steps.ai_analysis.outputs.error_name }} [${{ steps.extract_ver.outputs.version }}]"
            git push
            echo "âœ… Pushed to logs/"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## âœ… Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.extract_ver.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Error ID:** ${{ steps.ai_analysis.outputs.error_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Error Name:** ${{ steps.ai_analysis.outputs.error_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Files Created" >> $GITHUB_STEP_SUMMARY
          echo "- Summary: \`logs/Error Summaries/${{ steps.create_files.outputs.summary_file }}\`" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.create_files.outputs.detail_file }}" ]; then
            echo "- Detail Log: \`logs/Detail Logs/${{ steps.create_files.outputs.detail_file }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- KB: \`logs/Error Knowledge Base.md\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ¤– AI Analysis" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          cat ai.json
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **For Perplexity:** Search in \`logs/\` folder" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: rm -rf current-log/ current-log.zip full-log.txt error-context-20.txt detail-log-path.txt detail-log-content.txt prompt.txt payload.json ai.json 2>/dev/null || true
